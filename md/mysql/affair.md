# 事务

## 1、事务简介

&emsp;&emsp;事务 是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。

&emsp;&emsp;比如: 张三给李四转账1000块钱，张三银行账户的钱减少1000，而李四银行账户的钱要增加
1000。 这一组操作就必须在一个事务的范围内，要么都成功，要么都失败。

&emsp;&emsp;注意：默认MySQL的事务是自动提交的，也就是说，当执行完一条DML语句时，MySQL会立即隐
式的提交事务。

## 2、事务操作

### &emsp;2.1、控制事务一

#### &emsp;&emsp;1）查看/设置事务提交方式

```sql
select @@autocommit;
set @@autocommit = 0;
```

&emsp;&emsp;&emsp;1是自动提交事务，0是手动提交

#### &emsp;&emsp;2）提交事务

```sql
commit;	
```

#### &emsp;&emsp;3）回滚事务

```sql
rollback;
```

&emsp;&emsp;注意：上述的这种方式，我们是修改了事务的自动提交行为, 把默认的自动提交修改为了手动提交, 此时我们执行的DML语句都不会提交, 需要手动的执行commit进行提交。

### 2.2、控制事务二

#### &emsp;1）开启事务

```sql
start transaction 或 begin	
```

#### &emsp;2）提交事务

```sql
commit;	
```

#### &emsp;3）回滚事务

```sql
rollback;
```

### 3、事务四大特性

| 特性                  | 含义                                                         |
| --------------------- | ------------------------------------------------------------ |
| 原子性(Atomicity)     | 事务是不可分割的最小操作单元，要么全部成功，要么全部失败     |
| 一致性（Consistency） | 事务完成时，必须使所有的数据保持一致状态                     |
| 隔离性(Isolation)     | 数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行 |
| 持久性(Durability)    | 事务一旦提交或回滚，它对数据库中的数据的改变就是永久的       |

&emsp;&emsp;上述就是事务的四大特性，简称ACID。

## 4、并发事务问题

| 问题       | 描述                                                         |
| ---------- | ------------------------------------------------------------ |
| 脏读       | 一个事务读到另一个事务还没有提交的数据，本意是想使用提交后的数据，但是读取了提交前的 |
| 不可重复读 | 一个事务先后读取同一条记录，但每次读取的数据不同，称之为不可重复读 |
| 幻读       | 一个事务按照条件查询数据时，没有对应的数据行，但是在插入数据时，又发现这行数据已经存在，好像出现了幻影 |

&emsp;&emsp;不可重复读和幻读的区别：

&emsp;&emsp;&emsp;不可重复读的重点在于修改了数据，而幻读的重点在于增加或删除了数据；

&emsp;&emsp;&emsp;解决不可重复读的问题只需要锁住满足条件的行即可，而解决幻读需要锁表；

## 5、事务隔离级别

&emsp;&emsp;为了解决并发事务所引发的问题，在数据库中引入了事务隔离级别，主要有以下几种：

| 隔离级别              | 脏读 | 不可重复读 | 幻读 |
| --------------------- | ---- | ---------- | ---- |
| read uncommitted      | √    | √          | √    |
| read committed        | ×    | √          | √    |
| repeatable read(默认) | ×    | ×          | √    |
| serializable          | ×    | ×          | ×    |

### &emsp;&emsp;5.1、查看事务隔离级别

```sql
select @@transaction_isolation
```

### &emsp;&emsp;5.2、设置事务隔离级别

```sql
set {session/global} transaction isolation level {read uncommitted/read committer/repeatable read/serializable}
```

&emsp;&emsp;&emsp;注意：事务隔离级别越高，数据越安全，但是性能越低

